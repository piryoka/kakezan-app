<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>苦手な掛け算ランダム練習（スマホ用）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, system-ui, "Segoe UI", sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      margin: 0;
      padding: 16px 8px 32px;
      background: #f7f7fb;
    }
    h1 {
      font-size: 1.1rem;
      margin-bottom: 8px;
      text-align: center;
    }
    .card {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 16px 12px 20px;
      text-align: center;
      width: 100%;
      max-width: 380px;
      margin-top: 8px;
    }
    .question {
      font-size: 2rem;
      margin: 0 0 10px;
    }
    .buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin: 10px 0 4px;
    }
    button.choice {
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 1.3rem;
      cursor: pointer;
      background: #4f46e5;
      color: #fff;
      min-width: 80px;
      touch-action: manipulation;
    }
    button.choice:active {
      transform: translateY(1px);
    }
    button#next-question {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.95rem;
      cursor: pointer;
      background: #e5e7eb;
      color: #111827;
      margin-top: 6px;
      touch-action: manipulation;
    }
    #feedback {
      font-size: 0.95rem;
      margin-top: 8px;
      min-height: 2.6rem;
      line-height: 1.4;
    }
    #feedback.correct {
      color: #15803d;
      font-weight: bold;
    }
    #feedback.wrong {
      color: #b91c1c;
      font-weight: bold;
    }
    .hint {
      font-size: 0.75rem;
      color: #666;
      margin-top: 8px;
      line-height: 1.5;
    }
    .small-note {
      margin-top: 12px;
      font-size: 0.75rem;
      color: #777;
      text-align: center;
      max-width: 380px;
    }
  </style>
</head>
<body>
  <h1>苦手な掛け算ランダム練習</h1>

  <div class="card">
    <div id="question" class="question">3 × 7 = ？</div>

    <div class="buttons" id="choices"></div>

    <div id="feedback"></div>

    <button id="next-question">つぎのもんだい</button>

    <div class="hint">
      どれかボタンをタップしてね。<br>
      正解なら「◯ 正解！」、<br>
      まちがえたら「× ○○じゃないよ。○○になるのは●×●だよ」と出ます。<br>
      えらんでから5秒後に自動でつぎのもんだいに変わります。
    </div>
  </div>

  <div class="small-note">
    iPhone / iPad の Safari で開いて使ってね。<br>
    （「ファイル」アプリ内のプレビューだと動かないことがあります）
  </div>

  <script>
    var problems = [
      { a: 3, b: 7 },
      { a: 2, b: 7 },
      { a: 7, b: 2 },
      { a: 6, b: 7 },
      { a: 6, b: 4 }
    ];

    var wrongPatterns = {
      "3x7": [
        { wrong: 28, wa: 4, wb: 7 },
        { wrong: 24, wa: 3, wb: 8 }
      ],
      "2x7": [
        { wrong: 18, wa: 3, wb: 6 }
      ],
      "7x2": [
        { wrong: 18, wa: 3, wb: 6 }
      ],
      "6x7": [
        { wrong: 28, wa: 4, wb: 7 }
      ],
      "6x4": [
        { wrong: 32, wa: 4, wb: 8 }
      ]
    };

    var questionEl = document.getElementById("question");
    var choicesEl = document.getElementById("choices");
    var feedbackEl = document.getElementById("feedback");
    var nextBtn = document.getElementById("next-question");

    var currentProblem = null;
    var autoNextTimer = null;
    var answered = false;

    function problemKey(p) {
      return p.a + "x" + p.b;
    }

    function pickRandomProblem() {
      var index = Math.floor(Math.random() * problems.length);
      currentProblem = problems[index];
    }

    function clearTimer() {
      if (autoNextTimer !== null) {
        clearTimeout(autoNextTimer);
        autoNextTimer = null;
      }
    }

    function shuffle(array) {
      for (var i = array.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var tmp = array[i];
        array[i] = array[j];
        array[j] = tmp;
      }
      return array;
    }

    function renderQuestion() {
      clearTimer();
      answered = false;
      feedbackEl.textContent = "";
      feedbackEl.className = "";
      if (!currentProblem) return;

      questionEl.textContent = currentProblem.a + " × " + currentProblem.b + " = ？";

      var result = currentProblem.a * currentProblem.b;
      var key = problemKey(currentProblem);
      var patterns = wrongPatterns[key] || [];

      var optionsSet = {};
      optionsSet[result] = true;
      for (var i = 0; i < patterns.length; i++) {
        optionsSet[patterns[i].wrong] = true;
      }
      var options = Object.keys(optionsSet).map(function(k){ return parseInt(k, 10); });
      shuffle(options);

      choicesEl.innerHTML = "";
      options.forEach(function(value) {
        var btn = document.createElement("button");
        btn.textContent = value;
        btn.className = "choice";
        btn.onclick = function() { handleChoice(value); };
        choicesEl.appendChild(btn);
      });
    }

    function handleChoice(selected) {
      if (!currentProblem || answered) return;
      answered = true;
      clearTimer();

      var result = currentProblem.a * currentProblem.b;
      var key = problemKey(currentProblem);
      var patterns = wrongPatterns[key] || [];

      if (selected === result) {
        feedbackEl.textContent = "◯ 正解！";
        feedbackEl.className = "correct";
      } else {
        var pattern = null;
        for (var i = 0; i < patterns.length; i++) {
          if (patterns[i].wrong === selected) {
            pattern = patterns[i];
            break;
          }
        }
        var message = "× " + selected + "じゃないよ。";
        if (pattern) {
          message += " " + selected + "になるのは " + pattern.wa + "×" + pattern.wb + " だよ。";
        }
        feedbackEl.textContent = message;
        feedbackEl.className = "wrong";
      }

      autoNextTimer = setTimeout(function() {
        nextQuestion();
      }, 5000);
    }

    function nextQuestion() {
      pickRandomProblem();
      renderQuestion();
    }

    nextBtn.onclick = function() {
      nextQuestion();
    };

    nextQuestion();
  </script>
</body>
</html>
